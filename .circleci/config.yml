version: 2
defaults: &defaults
    working_directory: ~/ohhey
    docker:
      - image: circleci/clojure:tools-deps
    environment: # environment variables for primary container
      AWS_REGION: "us-east-1"
      AWS_PROFILE: "ohhey"
      JVM_OPTS: -Xmx3200m # limit the maximum heap size to prevent out of memory errors

jobs:
  build:
    <<: *defaults
    steps:
      - checkout # check out source code to working directory
      - run: mkdir ~/.aws && echo $AWS_CREDENTIALS | base64 --decode > ~/.aws/credentials
      - restore_cache: # restores saved cache if checksum hasn't changed since the last run
          key: ohhey-deps-{{ checksum "api/deps.edn" }}
      - run: clojure -A:test -e ":success"
      - persist_to_workspace:
          root: ~/
          paths:
            - ohhey
            - .aws

      - save_cache: # generate and store cache in the .m2 directory using a key template
          paths:
            - ~/.m2
            - api/.cpcache
          key: ohhey-deps-{{ checksum "api/deps.edn" }}

  test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/
      - run: cd api && bin/kaocha peer

  integration_test:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/
      - run: apt-get install python python-pip
      - run: pip install awscli
      - run:
          command: cd api && ./bin/datomic-socks-proxy -p ohhey -r us-east-1 dev
          background: true
      - run: cd api && bin/kaocha client

  push:
    <<: *defaults
    steps:
      - attach_workspace:
          at: ~/
      - run: cd api && bin/push

workflows:
  version: 2
  build_test_push:
    jobs:
      - build
      - test:
          requires:
            - build
      - integration_test:
          requires:
            - build
          filters:
            branches:
              only: master
      - push:
          requires:
            - test
            - integration_test
          filters:
            branches:
              only: master
